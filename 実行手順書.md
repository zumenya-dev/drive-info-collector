# Google Drive 共有ドライブ情報収集ツール 実行手順書

**バージョン:** 1.2
**作成日:** 2024年9月29日
**最終更新:** 2025年9月30日
**対象者:** 情報システム部門担当者
**所要時間:** セットアップ30分 + 実行時間（ドライブ数により変動）

---

## 📋 目次

1. [事前準備](#事前準備)
2. [Google Apps Scriptプロジェクト作成](#google-apps-scriptプロジェクト作成)
3. [コードの設定とデプロイ](#コードの設定とデプロイ)
4. [実行とモニタリング](#実行とモニタリング)
5. [結果の確認と分析](#結果の確認と分析)
6. [トラブルシューティング](#トラブルシューティング)

---

## 🔧 事前準備

### 1. 必要な権限の確認

以下の権限を持つGoogleアカウントで作業してください：
- ✅ **Google Workspace 特権管理者権限**（必須）
  - `useDomainAdminAccess` オプションを使用するため、特権管理者（スーパー管理者）権限が必要です
  - または「ドライブとドキュメントの設定」権限を持つカスタム管理者ロール
- ✅ **調査対象の共有ドライブへのメンバー権限**
  - 共有ドライブに「閲覧者」以上の権限で追加されている必要があります
  - メンバーでない共有ドライブは一覧には表示されますが、中身のファイルは取得できません
- ✅ **Google Apps Scriptの利用権限**

### 2. 必要な情報の準備

- 📧 **実行許可ユーザーのメールアドレス** （複数可、例: `user@example.co.jp`）
- 🏢 **会社のドメイン名** （例：`example.co.jp` - 外部共有判定に使用）
  - ⚠️ **重要**: このドメインと一致する組織内ドメイン共有は「外部共有」としてカウントされません
- 📁 **除外したい共有ドライブがある場合は、そのリスト**

### 3. 共有ドライブへのメンバー追加

⚠️ **重要な前提条件**

調査対象の共有ドライブに、実行ユーザーを**メンバーとして追加**してください：

1. Google Drive で対象の共有ドライブを開く
2. 右上の「メンバーを管理」をクリック
3. 実行ユーザーのメールアドレスを追加（最低「閲覧者」権限）

**権限継承の仕組み：**
- 共有ドライブのメンバーになると、配下の**全てのフォルダ・ファイル**に自動的にアクセス可能
- 個別のフォルダやファイルに権限設定がなくても、メンバーなら全て取得できます
- 共有ドライブより厳しい権限は設定できない仕様のため、メンバーは必ず全体にアクセス可能

---

## 🚀 Google Apps Scriptプロジェクト作成

### Step 1: Google Apps Scriptにアクセス

1. ブラウザで [script.google.com](https://script.google.com) を開く
2. 「新しいプロジェクト」をクリック

### Step 2: プロジェクト名の設定

1. 左上の「無題のプロジェクト」をクリック
2. 「Drive情報収集ツール」と入力
3. 「名前を変更」をクリック

### Step 3: デフォルトコードの削除

1. `コード.gs` ファイル内の全てのコードを削除
2. 空の状態にする

---

## 💻 コードの設定とデプロイ

### Step 1: メインコードの追加

1. `コード.gs` ファイルに、提供された `コード.gs` の内容を**全てコピー&ペースト**
2. ⚠️ **重要**: 以下の設定項目を必ず変更してください：

```javascript
const CONFIG = {
  // ✏️ 実行許可ユーザーのメールアドレスを入力
  ALLOWED_USERS: [
    '*******@********.co.jp'   // ← 実際のメールアドレスに変更（複数指定可能）
  ],

  // ✏️ 会社ドメインを入力（外部共有判定に使用）
  COMPANY_DOMAIN: '********.co.jp'      // ← 実際のドメインに変更
};
```

### Step 2: Advanced Servicesの有効化

1. 左メニューの **「サービス」** をクリック
2. **「サービスを追加」** をクリック
3. **「Drive API」** を検索して選択
4. バージョンは **「v3」** を選択
5. **「追加」** をクリック

### Step 3: マニフェストファイルの設定

1. 左メニューの **「プロジェクトの設定」** をクリック
2. **「マニフェストファイルをエディタで表示する」** にチェック
3. 左メニューに現れる **「appsscript.json」** をクリック
4. 既存の内容を削除し、提供された `appsscript.json` の内容をペースト

### Step 4: 保存と初回承認

1. **Ctrl+S** (または **Cmd+S**) で保存
2. `main` 関数を選択
3. **「実行」** ボタンをクリック
4. 初回実行時は権限承認が必要：
   - **「承認が必要です」** → **「権限を確認」**
   - Googleアカウントを選択
   - **「詳細」** → **「GIC_Drive情報収集ツール（安全ではないページ）に移動」**
   - **「許可」** をクリック

---

## ⚡ 実行とモニタリング

### Step 1: 実行開始

1. 関数ドロップダウンで **`main`** を選択
2. **「実行」** ボタンをクリック
3. 実行ログが表示されます

### Step 2: 進捗の確認

実行中は以下で進捗を確認できます：

#### **ログでの確認**
- 画面下部の **「実行ログ」** タブをクリック
- リアルタイムで処理状況が表示される

#### **スプレッドシートでの確認**
- 自動作成される **「Drive情報収集結果」** スプレッドシートを開く
- **「00_実行管理」** シートで進捗率を確認

### Step 3: 実行時間制限への対応

⏰ **Google Apps Scriptは6分の実行制限があります**

- 大量の共有ドライブがある場合、自動的に一時停止されます
- 一時停止された場合：
  1. 関数ドロップダウンで **`continueExecution`** を選択
  2. **「実行」** ボタンをクリック
  3. 処理が続行されます

---

## 📊 結果の確認と分析

### Step 1: スプレッドシートの確認

実行完了後、以下のスプレッドシートが作成されます：

#### **「Drive情報収集結果」スプレッドシート**

```
📋 00_共有ドライブ一覧        ← 全ドライブの概要
📁 01_営業部ドライブ         ← 各ドライブの詳細
📁 02_技術部ドライブ         ← 各ドライブの詳細
📁 03_管理部ドライブ         ← 各ドライブの詳細
...
🚨 99_エラーログ            ← エラー発生時のみ
```

### Step 2: データの読み方

#### **マスターシート（00_共有ドライブ一覧）**
| 列 | 内容 | 説明 |
|---|---|---|
| No | 番号 | ドライブの連番 |
| ドライブ名 | 名前 | 共有ドライブの表示名 |
| ファイル数 | 件数 | 含まれるファイル・フォルダ数 |
| 外部共有 | 状況 | 組織内ドメイン共有と外部共有の有無・件数 |
| 状況 | 処理状況 | 完了/エラー/未処理 |

#### **個別ドライブシート（01_xxx）**
| 列 | 内容 | 説明 |
|---|---|---|
| レベル | 深度 | フォルダの階層（0=ルート） |
| パス | 場所 | フルパス表記 |
| 種別 | タイプ | ファイル/フォルダ |
| 権限 | アクセス権 | 権限の詳細情報 |
| 外部共有 | 共有状況 | 組織内共有/外部共有の区別表示 |

---

## 🛠️ トラブルシューティング

### よくある問題と解決方法

#### **❌ エラー: 実行権限がありません**

**原因:** `CONFIG.ALLOWED_USERS` にユーザーのメールアドレスが設定されていない

**解決方法:**
1. `コード.gs` の `CONFIG.ALLOWED_USERS` を確認
2. 実行者のメールアドレスを配列に追加（例: `['user@example.co.jp']`）
3. 保存して再実行

#### **❌ エラー: Drive APIが見つかりません**

**原因:** Advanced Servicesが有効化されていない

**解決方法:**
1. 左メニュー「サービス」→「サービスを追加」
2. 「Drive API」を検索して追加
3. バージョンは「v3」を選択

#### **❌ エラー: 権限が不足しています**

**原因:**
- 実行ユーザーが特権管理者（スーパー管理者）ではない
- 共有ドライブのメンバーとして追加されていない

**解決方法:**
1. **特権管理者権限を確認**
   - Google Workspace 管理コンソール → ユーザー → 実行ユーザーを選択
   - 「特権管理者」ロールが付与されているか確認
2. **共有ドライブのメンバーに追加**
   - 調査したい共有ドライブに「閲覧者」以上の権限で追加
   - メンバーでない共有ドライブは、一覧には表示されるが中身は取得できません

#### **⏰ 処理が途中で止まる**

**原因:** 6分の実行時間制限

**解決方法:**
1. `continueExecution` 関数を実行
2. 必要に応じて複数回実行
3. 大量のドライブがある場合は分割実行を検討

#### **📊 スプレッドシートが見つからない**

**原因:** 作成権限がない、またはドライブの容量不足

**解決方法:**
1. Google Driveの容量を確認
2. スプレッドシート作成権限を確認
3. 手動でスプレッドシートを作成後、名前を「Drive情報収集結果」に設定

---

**⚠️ 注意事項**
- 本ツールは読み取り専用で、Drive内のファイルを変更することはありません
- 大量のAPIリクエストが発生するため、Google Workspaceの制限に注意してください
- 機密情報を含む可能性があるため、結果の取り扱いには十分注意してください

**🔍 ツールの動作仕様**
- `useDomainAdminAccess: true` により、組織内の全共有ドライブ一覧を取得可能
- ただし、**メンバーでない共有ドライブの中身（ファイル・フォルダ）は取得できません**
- ファイル情報を取得するには、対象の共有ドライブに「閲覧者」以上の権限で追加される必要があります
- 共有ドライブのメンバーになれば、配下の全てのフォルダ・ファイルに自動的にアクセス可能です

---