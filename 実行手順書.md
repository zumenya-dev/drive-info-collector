# Google Drive 共有ドライブ情報収集ツール 実行手順書

**バージョン:** 2.1
**最終更新:** 2025年10月5日
**対象者:** Google Workspace管理者・情報システム担当者
**所要時間:** セットアップ20分 + 実行時間（ドライブ数により変動）

---

## 📋 目次

1. [このツールでできること](#このツールでできること)
2. [事前準備](#事前準備)
3. [初期セットアップ](#初期セットアップ)
4. [実行方法](#実行方法)
5. [結果の確認](#結果の確認)
6. [応用操作](#応用操作)
7. [トラブルシューティング](#トラブルシューティング)

---

## 🎯 このツールでできること

このツールは、Google Workspaceの**共有ドライブ**の情報を網羅的に収集し、スプレッドシートで一覧化します。

### 主な機能

✅ **全共有ドライブの一覧取得**
- 組織内の全共有ドライブを自動検出
- ドライブごとのファイル数・容量・権限情報を集計

✅ **ファイル・フォルダの詳細情報取得**
- 階層構造を保持したフルパス表示
- 作成者・作成日・更新日・サイズ
- 各ファイル・フォルダの詳細な権限情報

✅ **外部共有の検出**
- 組織外ユーザーとの共有を自動検出
- ドメイン全体公開の検出
- リスク分析に活用可能

✅ **大量データ対応**
- 1000件以上のファイルも分割処理で確実に取得
- 途中で中断しても安全に再開可能
- 任意の共有ドライブのみ選択処理が可能

### 出力イメージ

```
📊 Drive情報収集結果（スプレッドシート）
├─ 00_共有ドライブ一覧    ← 全ドライブの概要
├─ 01_営業部             ← 各ドライブの全ファイル詳細
├─ 02_技術部             ← 各ドライブの全ファイル詳細
└─ 03_管理部             ← 各ドライブの全ファイル詳細
```

---

## 🔧 事前準備

### 1. 必要な権限

実行ユーザーは以下の権限が必要です:

| 権限 | 必須 | 用途 |
|------|------|------|
| **特権管理者（スーパー管理者）** | ✅ 必須 | 組織内全共有ドライブ一覧の取得 |
| **調査対象共有ドライブのメンバー** | ✅ 必須 | ファイル・フォルダ情報の取得 |
| **Google Apps Script利用権限** | ✅ 必須 | ツールの実行 |

⚠️ **重要な注意点**
- 特権管理者権限があっても、**共有ドライブのメンバーでない場合**は中身のファイル情報は取得できません
- 調査したい全共有ドライブに、実行ユーザーを**「閲覧者」以上の権限で追加**してください

### 2. 必要な情報の準備

設定に必要な情報を事前に確認してください:

- 📧 **実行許可ユーザーのメールアドレス**
  - 例: `admin@example.co.jp`
  - 複数のユーザーに実行権限を与える場合はカンマ区切りで追加可能

- 🏢 **組織のドメイン名**
  - 例: `example.co.jp`
  - 外部共有判定に使用（このドメイン以外が「外部」と判定されます）

---

## 🚀 初期セットアップ

### Step 1: Google Apps Scriptプロジェクトの作成

1. ブラウザで [script.google.com](https://script.google.com) を開く
2. **「新しいプロジェクト」** をクリック
3. プロジェクト名を **「Drive情報収集ツール」** に変更

### Step 2: コードの配置

1. デフォルトの `コード.gs` 内のコードを**全て削除**
2. 提供された **`コード.gs`** の内容を**全てコピー&ペースト**
3. **Ctrl+S** (Mac: **Cmd+S**) で保存

### Step 3: 設定のカスタマイズ（必須）

コード内の以下の箇所を**必ず編集**してください:

```javascript
const CONFIG = {
  SPREADSHEET_NAME: 'Drive情報収集結果',
  BATCH_SIZE: 1000,
  API_DELAY: 100,
  MAX_EXECUTION_TIME: 330,
  MAX_FILES_PER_BATCH: 1000,
  MAX_DEPTH: 10,
  ALLOWED_USERS: ['*****@*****.co.jp'],  // ← ここを変更
  COMPANY_DOMAINS: ['******.co.jp']        // ← ここを変更
};
```

#### 📝 変更箇所の詳細

**`ALLOWED_USERS`（実行許可ユーザー）**
```javascript
// 単一ユーザーの場合
ALLOWED_USERS: ['admin@example.co.jp']

// 複数ユーザーの場合
ALLOWED_USERS: ['admin@example.co.jp', 'user@example.co.jp']
```

**`COMPANY_DOMAINS`（組織ドメイン）**
```javascript
// 単一ドメインの場合
COMPANY_DOMAINS: ['example.co.jp']

// 複数ドメインの場合（グループ企業など）
COMPANY_DOMAINS: ['example.co.jp', 'subsidiary.co.jp']
```

### Step 4: appsscript.jsonの設定

このステップでOAuthスコープとDrive APIの設定を行います。

1. 左メニューの **「プロジェクトの設定」**（⚙️アイコン）をクリック
2. **「appsscript.json」マニフェスト ファイルをエディタで表示する** にチェックを入れる
3. 左メニューのファイル一覧に **「appsscript.json」** が表示されるのでクリック
4. 以下の内容に**置き換え**:

```json
{
  "timeZone": "Asia/Tokyo",
  "dependencies": {
    "enabledAdvancedServices": [
      {
        "userSymbol": "Drive",
        "version": "v3",
        "serviceId": "drive"
      }
    ]
  },
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/userinfo.email"
  ]
}
```

5. **Ctrl+S** (Mac: **Cmd+S**) で保存

⚠️ **重要**: この設定により以下が有効化されます:
- **Drive API v3**: 共有ドライブとファイル情報の取得
- **OAuthスコープ**: Drive、Spreadsheet、ユーザー情報へのアクセス権限

### Step 5: 初回実行と権限承認

1. 関数ドロップダウンで **`driveGet`** を選択
2. **「実行」** ボタン(▶️)をクリック
3. 初回のみ権限承認ダイアログが表示されます:
   - **「承認が必要です」** → **「権限を確認」**
   - Googleアカウントを選択
   - ⚠️ **「このアプリは確認されていません」** と表示された場合:
     - **「詳細」** をクリック
     - **「Drive情報収集ツール（安全ではないページ）に移動」** をクリック
   - **「許可」** をクリック

これでセットアップは完了です！

---

## ⚡ 実行方法

### 🎬 基本の実行フロー

このツールは**2ステップ**で実行します:

```
ステップ1: driveGet()  → 共有ドライブ一覧を取得
ステップ2: fileGet()   → 各ドライブの詳細情報を取得（繰り返し実行）
```

---

### 📌 ステップ1: 共有ドライブ一覧の取得

#### 操作手順

1. 関数ドロップダウンで **`driveGet`** を選択
2. **「実行」** ボタン(▶️)をクリック
3. 実行ログを確認:

```
=== driveGet: 共有ドライブ一覧取得開始 ===
共有ドライブ数: 25
=== driveGet: 完了 ===
次に fileGet() を実行してファイル情報を取得してください。
```

#### 実行結果

- ✅ **「Drive情報収集結果」** スプレッドシートが自動作成される
- ✅ **`00_共有ドライブ一覧`** シートに全ドライブが一覧表示される
- ✅ 各ドライブの「状況」列は **「未処理」** となっている

---

### 📌 ステップ2: ファイル情報の取得

#### 操作手順

1. 関数ドロップダウンで **`fileGet`** を選択
2. **「実行」** ボタン(▶️)をクリック
3. 実行ログを確認:

```
=== fileGet: ファイル情報取得開始 ===
新規処理開始: 営業部ドライブ (ID: 0ABC...)
=== fileGet: 営業部ドライブ 処理完了 ===
ファイル: 450, フォルダ: 85, 容量: 2.5 GB
残り 24 件の共有ドライブが未処理です。再度 fileGet() を実行してください。
```

#### 実行結果

- ✅ **`01_営業部ドライブ`** シートが作成される
- ✅ **`00_共有ドライブ一覧`** の「状況」列が **「完了」** に更新される
- ✅ 自動的に次の「未処理」ドライブが処理対象になる

#### 繰り返し実行

**全ドライブの処理が完了するまで `fileGet()` を繰り返し実行してください。**

```
1回目: fileGet() → 営業部ドライブ処理 → 完了
2回目: fileGet() → 技術部ドライブ処理 → 完了
3回目: fileGet() → 管理部ドライブ処理 → 完了
...
25回目: fileGet() → 全て完了のダイアログ表示
```

全て完了すると、以下のダイアログが表示されます:

```
完了
全ての共有ドライブの処理が完了しています。
```

---

### 🔁 1000件以上のファイルがある場合

#### 自動分割処理

ファイル数が1000件を超える共有ドライブは、自動的に分割処理されます。

**実行例（4500ファイルの場合）:**

```
1回目: fileGet() → 1000件処理 → 「処理中 (1000件)」
2回目: fileGet() → 1000件処理 → 「処理中 (2000件)」
3回目: fileGet() → 1000件処理 → 「処理中 (3000件)」
4回目: fileGet() → 1000件処理 → 「処理中 (4000件)」
5回目: fileGet() →  500件処理 → 「完了」
```

#### 進捗の確認方法

**`00_共有ドライブ一覧`** シートの「状況」列を確認:

| ドライブ名 | 状況 | 意味 |
|-----------|------|------|
| 営業部 | **未処理** | まだ処理していない |
| 技術部 | **処理中 (2000件)** | 現在処理中（2000件まで完了） |
| 管理部 | **完了** | 処理完了 |

⚠️ **重要:** 「処理中」と表示されている場合は、**同じドライブを続けて処理するため、再度 `fileGet()` を実行**してください。

---

## 📊 結果の確認

### スプレッドシートの構成

実行完了後、以下のシートが生成されます:

```
📋 Drive情報収集結果
├─ 00_共有ドライブ一覧   ← マスターシート
├─ 01_営業部            ← 詳細シート
├─ 02_技術部            ← 詳細シート
└─ 03_管理部            ← 詳細シート
```

### マスターシート（00_共有ドライブ一覧）

全共有ドライブの概要が一覧表示されます。

| 列名 | 内容 | 例 |
|------|------|-----|
| No | 番号 | 1 |
| ドライブ名 | 共有ドライブ名 | 営業部ドライブ |
| ドライブID | Google DriveのID | 0ABCdef... |
| 作成日 | ドライブ作成日 | 2024/01/15 |
| ファイル数 | ファイル・フォルダ総数 | 450 |
| 容量(GB) | 合計サイズ | 2.35 |
| 対応シート | 詳細シート名 | 01_営業部ドライブ |
| 管理者 | ドライブの管理者 | 山田太郎:yamada@... |
| 外部共有 | 外部共有の有無 | 外部共有あり(5件) |
| 状況 | 処理状態 | 完了 |
| URL | ドライブへのリンク | https://drive.google.com/... |

### 詳細シート（01_xxx）

各共有ドライブの全ファイル・フォルダ情報が表示されます。

| 列名 | 内容 | 説明 |
|------|------|------|
| レベル | 階層の深さ | 0=ルート、1=第1階層... |
| パス | フルパス | /営業資料/2024年度/... |
| 種別 | タイプ | ファイル / フォルダ |
| 名前 | ファイル・フォルダ名 | 売上報告.xlsx |
| ID | Google DriveのID | 1ABCdef... |
| 親ID | 親フォルダのID | 0ABCdef... |
| 作成者 | 作成したユーザー | 山田太郎:yamada@... |
| 作成日 | 作成日時 | 2024/03/15 10:30 |
| 更新日 | 最終更新日時 | 2024/10/01 15:45 |
| サイズ | ファイルサイズ | 2.5 MB |
| 管理者 | organizer権限 | 山田太郎:yamada@... |
| コンテンツ管理者 | fileOrganizer権限 | 佐藤花子:sato@... |
| 投稿者 | writer権限 | 営業部メンバー |
| 編集者 | editor権限 | 田中次郎:tanaka@... |
| 閲覧者(コメント可) | commenter権限 | 企画部メンバー |
| 閲覧者 | reader権限 | 全社員 |
| 外部共有 | 外部共有状況 | 外部共有あり(2件) |
| URL | ファイルへのリンク | https://drive.google.com/... |

---

## 🎓 応用操作

### 🎯 任意の共有ドライブのみ処理したい場合

特定のドライブだけを調査したい場合の手順:

#### 方法1: 処理前の設定

1. **`driveGet()`** を実行して一覧を作成
2. **`00_共有ドライブ一覧`** シートを開く
3. 処理したい**ドライブのみ「未処理」**に、その他は**「完了」**に変更
4. **`fileGet()`** を実行

**例: 営業部ドライブのみ処理したい場合**

| No | ドライブ名 | 状況 | 操作 |
|----|-----------|------|------|
| 1 | 営業部 | **未処理** | ← そのまま |
| 2 | 技術部 | ~~未処理~~ → **完了** | ← 手動で変更 |
| 3 | 管理部 | ~~未処理~~ → **完了** | ← 手動で変更 |

→ `fileGet()` を実行すると、営業部のみ処理される

#### 方法2: 処理後の再実行

すでに全て処理済みの場合:

1. 再処理したいドライブの「状況」列を **「完了」→「未処理」** に変更
2. 再処理したいドライブのシート(例: `01_営業部`)を**削除**
3. **`fileGet()`** を実行

### 🔄 処理をやり直したい場合

#### 特定のドライブのみやり直す

1. 対象ドライブのシート(例: `03_管理部`)を**削除**
2. **`00_共有ドライブ一覧`** の該当行の「状況」を **「未処理」** に変更
3. **`fileGet()`** を実行

#### 全てやり直す

1. **「Drive情報収集結果」** スプレッドシートを**削除**
2. **`driveGet()`** から再実行

---

## 🛠️ トラブルシューティング

### ❌ エラー: 実行権限がありません

**エラーメッセージ:**
```
実行権限がありません。管理者にお問い合わせください。
```

**原因:**
`CONFIG.ALLOWED_USERS` に実行ユーザーのメールアドレスが設定されていない

**解決方法:**
1. `コード.gs` の13行目付近を確認:
```javascript
ALLOWED_USERS: ['*****@*****.co.jp'],  // ← ここを確認
```
2. 実行ユーザーのメールアドレスに変更
3. **Ctrl+S** で保存して再実行

---

### ❌ エラー: スプレッドシートIDが見つかりません

**エラーメッセージ:**
```
スプレッドシートIDが見つかりません。先に driveGet() を実行してください。
```

**原因:**
`fileGet()` を実行する前に `driveGet()` を実行していない

**解決方法:**
1. まず **`driveGet()`** を実行
2. その後 **`fileGet()`** を実行

---

### ❌ エラー: Drive APIが有効になっていません

**エラーメッセージ:**
```
Drive API has not been used in project...
```

**原因:**
Drive APIが有効化されていない

**解決方法:**
1. 左メニューの **「サービス」** をクリック
2. **「Drive API」** を検索して追加
3. バージョン **「v3」** を選択
4. **「追加」** をクリック

---

### ⚠️ 共有ドライブが一覧に表示されない

**症状:**
一部の共有ドライブが `00_共有ドライブ一覧` に表示されない

**原因:**
実行ユーザーが特権管理者ではない、または対象ドライブが削除されている

**解決方法:**
1. **特権管理者権限を確認:**
   - Google Workspace管理コンソール → ユーザー → 実行ユーザー
   - 「特権管理者」ロールが付与されているか確認
2. 対象ドライブが削除されていないか確認

---

### ⚠️ ファイル情報が取得できない

**症状:**
`00_共有ドライブ一覧` には表示されるが、`fileGet()` を実行してもファイル数が0になる

**原因:**
実行ユーザーが共有ドライブの**メンバーでない**

**解決方法:**

**重要:** 特権管理者権限があっても、共有ドライブのメンバーでないとファイル情報は取得できません

1. Google Driveで対象の共有ドライブを開く
2. 右上の **「メンバーを管理」** をクリック
3. 実行ユーザーを **「閲覧者」以上の権限で追加**
4. 追加後、再度 `fileGet()` を実行

**メンバー追加の確認方法:**
- 共有ドライブを開いて、左サイドバーに表示されるか確認
- 表示されればメンバーとして追加されています

---

### ⏰ 処理が途中で止まっている

**症状:**
`00_共有ドライブ一覧` の「状況」が **「処理中 (1000件)」** のまま進まない

**原因:**
1000件以上のファイルがあるドライブを分割処理中

**解決方法:**
**これは正常な動作です。** 再度 `fileGet()` を実行してください。

```
1回目: 処理中 (1000件)  ← ここで止まっている
2回目: 処理中 (2000件)  ← fileGet()を再実行
3回目: 処理中 (3000件)  ← fileGet()を再実行
4回目: 完了            ← fileGet()を再実行
```

---

### 🔍 外部共有の判定がおかしい

**症状:**
組織内ユーザーが「外部共有」と判定される

**原因:**
`CONFIG.COMPANY_DOMAINS` の設定が間違っている

**解決方法:**
1. `コード.gs` の14行目付近を確認:
```javascript
COMPANY_DOMAINS: ['******.co.jp']  // ← ここを確認
```
2. 正しい組織ドメインに変更
3. **スプレッドシートを削除**して `driveGet()` から再実行

---

## 📌 補足情報

### 権限の仕組み

#### 共有ドライブの権限継承

```
共有ドライブ (organizer: 山田太郎)
  ├─ フォルダA (個別権限なし)
  │   └─ ファイル1.xlsx (個別権限なし)
  │       → 管理者: 山田太郎 (上位から継承)
  │
  └─ フォルダB (writer: 佐藤花子)
      └─ ファイル2.pdf (個別権限なし)
          → 管理者: 山田太郎 (上位から継承)
          → 投稿者: 山田太郎, 佐藤花子 (上位+個別)
```

#### フォルダとファイルの権限表示の違い

| 権限列 | フォルダ | ファイル |
|--------|---------|---------|
| 管理者 | 上位+個別 | 上位のみ |
| コンテンツ管理者 | 上位+個別 | 上位のみ |
| 投稿者 | 上位+個別 | 上位のみ |
| **編集者** | **「ー」** | **個別のみ** |
| 閲覧者(コメント可) | 上位+個別 | 上位+個別 |
| 閲覧者 | 上位+個別 | 上位+個別 |

**理由:**
- フォルダには「編集者」の概念がないため「ー」と表示
- ファイルの「編集者」は個別設定のみ表示(上位の投稿者権限は別列に表示)

---

### 外部共有の判定基準

| 共有タイプ | 判定 | 表示例 |
|-----------|------|--------|
| 組織内ドメイン共有 | 内部 | 組織内共有あり |
| 組織外ユーザー | **外部** | 外部共有あり(3件) |
| 他組織ドメイン | **外部** | 外部共有あり(1件) |
| リンクを知っている全員 | **外部** | 外部共有あり(1件) |

複数該当する場合:
```
組織内共有あり, 外部共有あり(5件)
```

---

### 処理時間の目安

| 共有ドライブ数 | ファイル総数 | 所要時間 |
|---------------|-------------|---------|
| 10個 | 5,000件 | 約15分 |
| 50個 | 25,000件 | 約1時間 |
| 100個 | 50,000件 | 約2時間 |
| 200個 | 100,000件 | 約4時間 |

※ API制限により、実行回数が多い場合は処理時間が長くなる可能性があります

---

## ⚠️ 注意事項

### データの取り扱い

- 本ツールは**読み取り専用**で、ドライブ内のファイルを変更しません
- 取得した情報には**機密情報が含まれる可能性**があります
- 結果スプレッドシートの共有範囲に注意してください

### API制限

- Google Drive APIには**1日あたりの呼び出し制限**があります
- 大量のドライブを一度に処理する場合、翌日に分けて実行してください

### その他

- 削除された共有ドライブは一覧に表示されません
- アーカイブされた共有ドライブも通常通り処理されます

---

**🎉 以上で実行手順書は終了です。不明点があれば、管理者にお問い合わせください。**
