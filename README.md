# Google Drive 共有ドライブ情報収集ツール

**バージョン:** 2.1
**最終更新:** 2025年10月5日
**作成者:** Zumenya

## 📖 概要

Google Workspace環境の共有ドライブ情報を自動収集し、フォルダ構造、権限設定、外部共有状況を網羅的に調査するツールです。

**v2.1の特徴:**
- ✅ **2ステップ実行**: ドライブ一覧取得とファイル収集を分離
- ✅ **1000件超対応**: 大量ファイルを自動分割処理
- ✅ **任意ドライブ選択**: 特定の共有ドライブのみ処理可能
- ✅ **6分制限回避**: 1ドライブずつ確実に完了

## 🎯 このツールでできること

### 1. 共有ドライブの棚卸し
- 組織内の全共有ドライブを一覧化
- ファイル数、合計容量、作成日を自動集計
- 外部共有状況の可視化
- 🆕 **共有ドライブ設定の一括取得**: 組織外アクセス、メンバー外アクセス、フォルダ共有権限、コピー制限を自動収集

### 2. セキュリティリスクの検出
- **外部共有ファイルの特定**: 組織外ドメインへの共有を検出
- **組織内共有の区別**: 社内ドメイン共有と真の外部共有を分離
- **権限詳細の取得**: 閲覧者・編集者・管理者の完全なリスト
- **継承権限の可視化**: 共有ドライブレベルから継承された権限を表示
- 🆕 **設定の一括監査**: 組織のセキュリティポリシーに反する設定を一目で確認

### 3. 詳細なフォルダ構造の把握
- 最大10階層までの完全なツリー構造取得
- 各ファイルのフルパス表示
- 作成者、作成日、更新日、サイズの記録

## 🚀 クイックスタート

### 前提条件

| 必要なもの | 説明 |
|----------|------|
| **Workspace特権管理者権限** | `useDomainAdminAccess`オプション使用に必須 |
| **共有ドライブのメンバー権限** | ファイル詳細を取得するには「閲覧者」以上が必要 |
| **Drive API有効化** | Google Cloud ConsoleでDrive API v3を有効化 |

> **重要**: 特権管理者権限で全共有ドライブの一覧は取得できますが、メンバーでない共有ドライブの中身は取得できません。

### セットアップ（5分）

1. **GASプロジェクト作成**
   ```
   https://script.google.com → 新しいプロジェクト
   ```

2. **コードをコピー**
   - `コード.gs` の内容を貼り付け

3. **設定を変更**
   ```javascript
   const CONFIG = {
     ALLOWED_USERS: ['your-email@example.com'],  // 変更必須
     COMPANY_DOMAINS: ['example.com']            // 変更必須
   };
   ```

4. **Drive APIを有効化**
   ```
   サービス → Drive API v3 を追加
   ```

5. **appsscript.jsonを設定**
   ```json
   {
     "oauthScopes": [
       "https://www.googleapis.com/auth/drive",
       "https://www.googleapis.com/auth/spreadsheets"
     ]
   }
   ```

6. **権限を承認**
   - 初回実行時にOAuth画面で承認

### 実行方法（v2.1 2ステップ実行）

#### ステップ1: 共有ドライブ一覧の取得

```javascript
driveGet()
```

**実行結果:**
- `Drive情報収集結果` スプレッドシートが作成される
- `00_共有ドライブ一覧` シートに全ドライブが列挙
- 各ドライブのステータスが「未処理」になる

**ログ例:**
```
[driveGet] 実行開始
[driveGet] ユーザー確認: your-email@example.com
[driveGet] 共有ドライブ一覧取得中...
[driveGet] 5件の共有ドライブを検出
[driveGet] マスターシート作成完了
[driveGet] 実行完了
```

#### ステップ2: ファイル情報の取得（繰り返し実行）

```javascript
fileGet()
```

**実行動作:**
- `00_共有ドライブ一覧` シートから「未処理」のドライブを上から順に処理
- 1回の実行で1つの共有ドライブを処理
- 1000件を超えるファイルがある場合、自動的に分割処理
  - ステータスが「処理中(12/25)」のように進捗表示
  - **同じ `fileGet()` を繰り返し実行すると続きから再開**
- 処理完了後、ステータスが「完了」に変更
- 次回実行時は次のドライブに自動移行

**ログ例（1000件超の場合）:**
```
[fileGet] 実行開始
[fileGet] 処理対象: 営業部 (ID: 0ANxxx...)
[fileGet] フォルダキュー復元: 12個のフォルダ待機中
[fileGet] 処理継続中... (1000/2500件)
[fileGet] ステータス更新: 処理中(1000/2500)
[fileGet] 次回実行で続きから処理します

→ 再度 fileGet() を実行

[fileGet] 処理対象: 営業部 (ID: 0ANxxx...)
[fileGet] フォルダキュー復元: 5個のフォルダ待機中
[fileGet] 処理継続中... (2000/2500件)
...
[fileGet] 全ファイル取得完了(2500件)
[fileGet] ステータス更新: 完了
```

**全ドライブを処理するまで繰り返し:**
```javascript
fileGet()  // 1つ目のドライブ処理
fileGet()  // 2つ目のドライブ処理
fileGet()  // 3つ目のドライブ処理
// ... 全ドライブ分
```

### 応用操作: 任意の共有ドライブのみ処理する

特定の共有ドライブだけを処理したい場合:

1. **`00_共有ドライブ一覧`シートを開く**
2. **ステータス列(O列)を手動編集:**
   - 処理したいドライブ: `未処理`
   - 処理したくないドライブ: `完了`
3. **`fileGet()`を実行**
   - 「未処理」のドライブのみ処理される

**例:**
```
ドライブ名    | ステータス
-------------|----------
営業部       | 未処理      ← これが処理される
技術部       | 完了        ← スキップ
管理部       | 未処理      ← 営業部完了後に処理される
総務部       | 完了        ← スキップ
```

## 📋 出力データ構造

### マスターシート: `00_共有ドライブ一覧`

**基本情報 + 権限 + 🆕共有ドライブ設定:**

| No | 共有ドライブ名 | ドライブID | ファイル数 | 外部共有 | 🆕組織外アクセス | 🆕メンバー外アクセス | 🆕フォルダ共有 | 🆕コピー制限 | ステータス |
|----|-------------|-----------|----------|---------|--------------|----------------|------------|-----------|----------|
| 1  | 営業部       | 0ANxxx... | 1,234 | 外部共有あり(3件) | 許可 | 許可 | 許可 | 投稿者以上 | 完了 |
| 2  | 技術部       | 0ANyyy... | 856   | 組織内共有あり | 禁止 | 禁止 | 管理者のみ | 投稿者以上 | 完了 |
| 3  | 管理部       | 0ANzzz... | 423   | なし | 禁止 | 許可 | 許可 | 全員可 | 処理中(400/423) |

**🆕 共有ドライブ設定列の説明:**

| 列名 | 説明 | 値の意味 |
|-----|------|---------|
| **組織外アクセス** | 組織外のユーザーへのファイルアクセス許可 | **許可**: 組織外にも共有可能<br>**禁止**: 組織内ユーザーのみ |
| **メンバー外アクセス** | 共有ドライブメンバー以外へのアクセス許可 | **許可**: メンバー外にも共有可能<br>**禁止**: メンバーのみ |
| **フォルダ共有** | コンテンツ管理者によるフォルダ共有権限 | **許可**: コンテンツ管理者も共有可<br>**管理者のみ**: 管理者のみ共有可 |
| **コピー制限** | ダウンロード・コピー・印刷できるユーザー | **投稿者以上**: 投稿者+コンテンツ管理者のみ<br>**全員可**: 閲覧者も可能 |

**ステータスの意味:**
- **未処理**: まだ `fileGet()` 未実行
- **処理中(X/Y)**: X件処理済み、Y件中 → `fileGet()` を再実行
- **完了**: 全ファイル取得完了

### 個別ドライブシート: `01_ドライブ名`, `02_ドライブ名`...

**全18列の構成:**

| 列 | 項目 | 説明 |
|----|-----|------|
| A  | レベル | 階層深度(0=ルート) |
| B  | パス | フルパス |
| C  | 種別 | フォルダ/ファイル |
| D  | 名前 | ファイル・フォルダ名 |
| E  | ID | DriveファイルID |
| F  | 親ID | 親フォルダのID |
| G  | 作成者 | lastModifyingUser |
| H  | 作成日 | createdTime |
| I  | 更新日 | modifiedTime |
| J  | サイズ(B) | バイト単位のサイズ |
| K  | 管理者 | organizer権限 |
| L  | コンテンツ管理者 | fileOrganizer権限 |
| M  | 投稿者 | writer権限 |
| N  | 編集者 | 個別ファイルの編集者 |
| O  | 閲覧者(コメント可) | commenter権限 |
| P  | 閲覧者 | reader権限 |
| Q  | 外部共有 | 組織外共有の有無 |
| R  | URL | Drive URL |

**権限列の表示ルール:**

| 対象 | 上位権限(共有ドライブから継承) | 個別権限(直接設定) |
|-----|---------------------------|------------------|
| フォルダ | すべての権限列に表示 | 追加で表示(重複除去) |
| ファイル | 管理者・コンテンツ管理者・投稿者のみ | 編集者・閲覧者系は個別のみ |

**表示例:**

```
レベル | パス              | 種別     | 名前         | 管理者           | 投稿者          | 編集者          | 外部共有
0      | /                 | フォルダ | ルート        | 山田太郎:admin@  | 佐藤花子:sales@ | ー              | 組織内共有あり
1      | /営業資料/         | フォルダ | 営業資料      | 山田太郎:admin@  | 佐藤花子:sales@ | ー              | 組織内共有あり
2      | /営業資料/提案書.xlsx | ファイル | 提案書 | 山田太郎:admin@  | 佐藤花子:sales@ | 鈴木一郎:user@, 外部ユーザー:partner@external.com  | 外部共有あり(1件)
```

**外部共有の判定:**
- `COMPANY_DOMAINS` に含まれないドメインを「外部共有」とカウント
- 「組織内共有あり」= 社内ドメインへの共有のみ
- 「外部共有あり(N件)」= 組織外ドメインへの共有を検出

## 🔧 設定項目

### CONFIG設定（必須変更）

```javascript
const CONFIG = {
  // スプレッドシート設定
  SPREADSHEET_NAME: 'Drive情報収集結果',  // 結果シート名

  // パフォーマンス設定
  BATCH_SIZE: 1000,                       // 1回の処理件数上限
  API_DELAY: 100,                         // API呼び出し間隔(ms)
  MAX_EXECUTION_TIME: 330,                // 最大実行時間(秒)
  MAX_FILES_PER_BATCH: 1000,              // バッチ処理上限
  MAX_DEPTH: 10,                          // 最大階層深度

  // セキュリティ設定（必ず変更）
  ALLOWED_USERS: [
    'your-email@example.com'              // 実行許可ユーザー
  ],

  // 会社設定（必ず変更）
  COMPANY_DOMAINS: ['example.com']        // 組織内ドメイン（外部共有判定に使用）
};
```

**⚠️ 重要:**
- `ALLOWED_USERS`: このメールアドレス以外は実行不可
- `COMPANY_DOMAINS`: ここに含まれるドメインは「組織内共有」扱い

### SHEET_COLUMNS定数

```javascript
const SHEET_COLUMNS = {
  MASTER: {
    FILE_COUNT: 5,        // ファイル数列
    SIZE_GB: 6,           // 容量列
    SHEET_NAME: 8,        // シート名列
    EXTERNAL_SHARE: 14,   // 外部共有列
    STATUS: 15            // ステータス列
  },
  DATA_ROW_START: 2       // データ開始行
};
```

## 🔑 仕様と制限事項

### 共有ドライブアクセスの仕組み

#### ✅ `useDomainAdminAccess: true` でできること

- **全共有ドライブの一覧取得**
  - 組織内すべての共有ドライブを検出（メンバーでなくても）
  - 共有ドライブ名、ID、作成日などの基本情報取得

#### ❌ `useDomainAdminAccess: true` でもできないこと

- **メンバーでない共有ドライブの中身**
  - フォルダ・ファイル情報
  - 権限設定や外部共有状況
  - **ドメイン管理者でも、メンバー権限がなければ中身は取得不可**

#### ✅ メンバーになれば全て取得可能

共有ドライブに「閲覧者」として追加されれば:
- 配下の**全フォルダ・全ファイル**に自動アクセス可能
- 個別のフォルダ・ファイルに権限がなくても継承により閲覧可能
- 共有ドライブより厳しい権限は設定不可（仕様）

**権限継承の例:**
```
共有ドライブ「営業部」に「閲覧者」として追加
↓ 権限継承
/営業資料/                 → 閲覧可能
/営業資料/2024年/          → 閲覧可能
/営業資料/2024年/提案書.xlsx → 閲覧可能
```

### API制限

| 項目 | 制限 |
|-----|------|
| **GAS実行時間** | 6分（v2.1では自動分割で対応） |
| **Drive API呼び出し** | 1日あたりの上限あり（ファイルごとにPermissions.list実行） |
| **スプレッドシート** | 最大500万行 |
| **階層深度** | 最大10階層（CONFIG.MAX_DEPTHで変更可） |

### 必要なOAuthスコープ

```json
{
  "oauthScopes": [
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/spreadsheets"
  ]
}
```

## 🚨 トラブルシューティング

### よくある問題と解決策

| エラー | 原因 | 解決方法 |
|-------|-----|---------|
| **実行権限エラー** | `ALLOWED_USERS`に未登録 | CONFIG設定を確認 |
| **共有ドライブが空** | メンバー権限なし | 「閲覧者」として追加 |
| **処理中で止まる** | 1000件超のファイル | `fileGet()`を再実行 |
| **API制限エラー** | 1日の上限到達 | 翌日再実行、またはAPI_DELAYを増加 |
| **タイムアウト** | 6分制限 | v2.1では自動分割されるため通常発生しない |

### 進捗確認方法

1. **`00_共有ドライブ一覧`シートを確認**
   - 「ステータス」列(O列)を見る
   - 「処理中(X/Y)」= まだ処理中 → `fileGet()`を再実行
   - 「完了」= 処理完了

2. **ログを確認**
   ```
   表示 → ログ
   ```

3. **PropertiesServiceを確認**
   ```javascript
   function checkProgress() {
     const progress = PropertiesService.getScriptProperties().getProperty('currentProgress');
     Logger.log(progress);
   }
   ```

## 📊 分析事例

### セキュリティリスク検出

#### 外部共有ファイルの特定
```
1. 00_共有ドライブ一覧シートで「外部共有あり」を検索
2. 該当ドライブの詳細シートを開く
3. Q列「外部共有」で「外部共有あり」を検索
4. N列「編集者」で外部ドメインを確認
```

#### 退職者権限の検出
```
1. 詳細シートで権限列(K〜P列)を検索
2. 退職者のメールアドレスで検索
3. 該当ファイルの権限を管理者に報告
```

### 容量分析

#### 大容量ドライブの特定
```
1. 00_共有ドライブ一覧シートを「合計サイズ(GB)」列で降順ソート
2. 上位ドライブの詳細シートを開く
3. J列「サイズ(B)」で降順ソート
4. 大容量ファイルを特定
```

### 古いファイルの検出

```
1. 詳細シートのI列「更新日」でフィルタ
2. 1年以上前のファイルを抽出
3. アーカイブ対象としてリスト化
```

## 📄 ライセンス

このツールはMITライセンスの下で公開されています。
商用・非商用問わず自由に利用できますが、無保証です。

## 📝 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| **2.2** | 2025/10/06 | **🆕 共有ドライブ設定取得機能追加**: 組織外アクセス、メンバー外アクセス、フォルダ共有権限、コピー制限を00_共有ドライブ一覧シートに自動出力、セキュリティ監査の効率化 |
| **2.1** | 2025/10/05 | **コード最適化**: v1.x互換関数削除、SHEET_COLUMNS定数追加、createEmptyMembers()ヘルパー関数追加、可読性向上(911行に削減)、README完全リニューアル |
| **2.0** | 2025/10/02 | **大規模環境対応**: driveGet()とfileGet()による2ステップ実行、1000件超自動分割、6分制限回避、任意ドライブ選択可能 |
| 1.3 | 2025/09/30 | 権限表示改善: 管理者列追加、上位/個別権限の適切表示、重複除去 |
| 1.2 | 2025/09/30 | useDomainAdminAccessオプション追加 |
| 1.1 | 2025/09/30 | 権限取得強化、組織内/外部共有区別、統計情報収集 |
| 1.0 | 2025/09/29 | 初回リリース |

---

**詳細な実行手順書**: [実行手順書.md](./実行手順書.md) を参照してください。
